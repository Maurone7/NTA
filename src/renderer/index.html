<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title></title>
    <!-- Content Security Policy: relaxed in dev to allow file:// for local preview assets (images, media, frames).
      In production you should remove file: and serve resources via a secure preload/handler. -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: blob:; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob: file:; media-src 'self' data: blob: file:; connect-src 'self' http: https:; object-src 'none'; frame-src 'self' data: blob: file:;">
    <link rel="stylesheet" href="./styles.css" />
    <link rel="stylesheet" href="../../node_modules/katex/dist/katex.min.css" />
  </head>
  <body>
    <!-- Skip to main content link for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
  <!-- Title bar removed: macOS custom title bar has been removed per user request -->
    <!-- Update notification removed -->

    <!-- Tab Bar (removed) -->

    <div class="app-shell">
      <aside class="explorer" aria-label="Workspace explorer">
        <div class="explorer__header">
          <div class="explorer__title-block">
            <div id="workspace-path" class="explorer__path no-folder">No folder open</div>
          </div>
          <div class="explorer__actions">
            <button
              id="open-folder-button"
              class="icon-button small"
              data-tooltip="Open Folder (‚åòO)"
            >
              <span class="icon">üìÅ</span>
            </button>
          </div>
        </div>
        <div id="workspace-tree" class="explorer__tree" role="tree" aria-label="Workspace files"></div>
        <div id="workspace-empty" class="explorer__empty">
          <div class="empty-state">
            <div class="empty-state__icon">üìÅ</div>
            <div class="empty-state__title">No folder open</div>
          </div>
        </div>
        <div class="hashtag-container">
          <div id="hashtag-resize-handle" class="hashtag-resize-handle" title="Drag to resize hashtag panel"></div>
          <section id="hashtag-panel" class="explorer__section" aria-label="Hashtag index">
            <header class="explorer__section-header">
              <div class="explorer__section-title">Hashtags</div>
              <div class="explorer__section-actions">
                <button id="toggle-hashtag-minimize" class="ghost small" type="button" title="Minimize/Restore hashtags">‚ñæ</button>
                <button id="clear-hashtag-filter" class="ghost small" type="button" hidden>Clear</button>
              </div>
            </header>
            <div id="hashtag-empty" class="explorer__empty" hidden>
              <div class="empty-state">
                <div class="empty-state__title">No hashtags yet, add an hastags with #</div>
              </div>
            </div>
            <div id="hashtag-list" class="hashtag-list" role="list"></div>
            <div id="hashtag-detail" class="hashtag-detail" hidden aria-live="polite"></div>
          </section>
        </div>
      </aside>
      <div class="sidebar-resize-handle" title="Drag to resize sidebar"></div>
      <button
        id="toggle-sidebar-button"
        type="button"
        class="ghost icon-button toggle-sidebar-button"
        title="Hide sidebar (‚åòB)"
        aria-label="Hide sidebar"
        aria-pressed="false"
      >
        <span class="icon" aria-hidden="true">‚óÄ</span>
      </button>
      <main class="workspace" id="main-content">
        <div class="workspace__toolbar">
          <div class="workspace__filemeta">
            <div class="workspace__filename-wrapper">
              <div class="workspace__filename" id="file-name" tabindex="0">No file selected</div>
              <form id="rename-file-form" class="rename-file-form" hidden>
                <input
                  id="rename-file-input"
                  name="fileName"
                  type="text"
                  placeholder="Untitled.md"
                  autocomplete="off"
                  required
                />
              </form>
            </div>
            <div class="workspace__filepath" id="file-path">Open a folder and select a file to get started.</div>
          </div>
          <div class="workspace__actions">
            <button
              id="toggle-math-wysiwyg-button"
              type="button"
              class="ghost icon-button"
              title="Toggle Math WYSIWYG (‚åòL)"
              aria-label="Toggle Math WYSIWYG"
              aria-pressed="false"
            >
              <span class="icon" aria-hidden="true">‚àë</span>
            </button>
            <button
              id="generate-toc-button"
              type="button"
              class="ghost icon-button"
              title="Generate Table of Contents (‚åòT)"
              aria-label="Generate Table of Contents"
            >
              <span class="icon" aria-hidden="true">üìë</span>
            </button>
            <button
              id="show-stats-button"
              type="button"
              class="ghost icon-button"
              title="Show Note Statistics (‚åòI)"
              aria-label="Show Note Statistics"
            >
              <span class="icon" aria-hidden="true">üìä</span>
            </button>
            <button
              id="show-templates-button"
              type="button"
              class="ghost icon-button"
              title="Note Templates (‚åò‚áßT)"
              aria-label="Note Templates"
            >
              <span class="icon" aria-hidden="true">üìù</span>
            </button>
            <button
              id="insert-matrix-table-button"
              type="button"
              class="ghost icon-button"
              title="Insert Matrix/Table (‚åò‚áßM)"
              aria-label="Insert Matrix or Table"
            >
              <span class="icon" aria-hidden="true">üî¢</span>
            </button>
            <div class="export-dropdown">
              <button
                id="export-dropdown-button"
                class="ghost export-dropdown__button"
                title="Export current note (‚åòE)"
                aria-haspopup="true"
                aria-expanded="false"
              >
                Export as
                <span class="export-dropdown__arrow">‚ñº</span>
              </button>
              <div class="export-dropdown__menu" id="export-dropdown-menu" role="menu">
                <button
                  id="export-pdf-option"
                  class="export-dropdown__option"
                  role="menuitem"
                  title="Export as PDF"
                >
                  PDF
                </button>
                <button
                  id="export-html-option"
                  class="export-dropdown__option"
                  role="menuitem"
                  title="Export as HTML"
                >
                  HTML
                </button>
                <button
                  id="export-docx-option"
                  class="export-dropdown__option"
                  role="menuitem"
                  title="Export as Word document"
                >
                  DOCX
                </button>
                <button
                  id="export-epub-option"
                  class="export-dropdown__option"
                  role="menuitem"
                  title="Export as EPUB ebook"
                >
                  EPUB
                </button>
              </div>
            </div>
            <!-- toggle-split-button removed -->
          </div>
        </div>
        <div class="workspace__content">
          <section class="editor-pane editor-pane--left" aria-label="Markdown editor (left)">
            <div class="editor-pane__badge" data-pane="left"></div>
            <div class="pane-tab-bar">
              <div class="tab-bar__tabs" id="tab-bar-tabs-left" role="tablist"></div>
            </div>
            <div
              id="editor-search-highlights"
              class="editor-search-highlights"
              aria-hidden="true"
              hidden
            >
              <div id="editor-search-highlights-content" class="editor-search-highlights__content"></div>
            </div>
            <textarea id="note-editor" spellcheck="true" aria-label="Markdown editor (left)"></textarea>
            <div id="editor-math-overlay" class="editor-math-overlay" aria-hidden="true" hidden></div>
            
            <!-- Search Overlay -->
            <div id="editor-search" class="editor-search-overlay" hidden>
              <div class="search-inputs">
                <input
                  id="editor-search-input"
                  type="text"
                  placeholder="Search in note‚Ä¶ (‚åòF)"
                  aria-label="Search in current note"
                  autocomplete="off"
                />
                <input
                  id="editor-replace-input"
                  type="text"
                  placeholder="Replace with‚Ä¶"
                  aria-label="Replace with"
                  autocomplete="off"
                  hidden
                />
              </div>
              <div class="search-controls">
                <div class="left-controls">
                  <button type="button" id="editor-search-case" aria-label="Match case" title="Match case (Aa)" class="search-toggle">Aa</button>
                  <button type="button" id="editor-search-replace-toggle" aria-label="Toggle replace" title="Toggle replace mode" class="search-toggle">‚áÑ</button>
                  <button type="button" id="editor-search-prev" aria-label="Previous match (‚Üë)" title="Previous match (‚Üë)">‚Üë</button>
                  <button type="button" id="editor-search-next" aria-label="Next match (‚Üì)" title="Next match (‚Üì)">‚Üì</button>
                  <button type="button" id="editor-replace-one" aria-label="Replace" title="Replace current match" hidden>Replace</button>
                  <button type="button" id="editor-replace-all" aria-label="Replace All" title="Replace all matches" hidden>All</button>
                </div>
                <div class="right-controls">
                  <div id="editor-search-count" class="search-count" aria-live="polite">0 / 0</div>
                  <button type="button" id="editor-search-close" aria-label="Close search (Esc)" title="Close search (Esc)">‚úï</button>
                </div>
              </div>
            </div>
            
            <!-- Math Preview Popup -->
            <div id="math-preview-popup" class="math-preview-popup" hidden>
              <div class="math-preview-popup__content"></div>
            </div>
            
            <div
              id="wikilink-suggestions"
              class="wiki-suggest"
              role="listbox"
              aria-label="Wiki link suggestions"
              hidden
            ></div>
            <div
              id="hashtag-suggestions"
              class="wiki-suggest"
              role="listbox"
              aria-label="Hashtag suggestions"
              hidden
            ></div>
            <div
              id="file-suggestions"
              class="wiki-suggest"
              role="listbox"
              aria-label="File path suggestions"
              hidden
            ></div>
            
            <!-- Inline Chat Widget -->
            <div id="inline-chat" class="inline-chat" hidden>
              <div class="inline-chat__header">
                <div class="inline-chat__title">
                  <span class="inline-chat__icon">üí¨</span>
                  <span>Chat</span>
                </div>
                <div class="inline-chat__actions">
                  <button id="inline-chat-close" class="inline-chat__close" type="button" title="Close chat (Escape)">
                    ‚úï
                  </button>
                </div>
              </div>
              <div class="inline-chat__content">
                <div id="inline-chat-messages" class="inline-chat__messages"></div>
                <div class="inline-chat__input-container">
                  <textarea
                    id="inline-chat-input"
                    class="inline-chat__input"
                    placeholder="Ask a question or describe what you want to do..."
                    rows="1"
                    aria-label="Chat input"
                  ></textarea>
                  <div class="inline-chat__input-actions">
                    <button id="inline-chat-send" class="inline-chat__send" type="button" title="Send message (Enter)">
                      ‚û§
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <!-- Divider between the two central editors -->
          <div class="editors__divider" aria-hidden="true"></div>
          <!-- Add right editor pane for side-by-side editing -->
          <section class="editor-pane editor-pane--right" aria-label="Markdown editor (right)">
            <div class="editor-pane__badge" data-pane="right"></div>
            <div class="pane-tab-bar">
              <div class="tab-bar__tabs" id="tab-bar-tabs-right" role="tablist"></div>
            </div>
            <div
              id="editor-search-highlights-right"
              class="editor-search-highlights"
              aria-hidden="true"
              hidden
            >
              <div id="editor-search-highlights-content-right" class="editor-search-highlights__content"></div>
            </div>
            <textarea id="note-editor-right" spellcheck="true" aria-label="Markdown editor (right)"></textarea>
            <div id="editor-math-overlay-right" class="editor-math-overlay" aria-hidden="true" hidden></div>
          </section>

          <div
            id="workspace-splitter"
            class="workspace__splitter"
            role="separator"
            aria-orientation="vertical"
            aria-label="Resize editor and preview"
            tabindex="0"
          ></div>

          <button
            id="toggle-preview-button"
            type="button"
            class="ghost icon-button toggle-preview-button"
            title="Hide preview (‚åò‚áßB)"
            aria-label="Hide preview"
            aria-pressed="false"
          >
            <span class="icon" aria-hidden="true">‚ñ∂</span>
          </button>

          <section class="preview-pane" aria-label="Preview" tabindex="-1">
            <div id="markdown-preview" class="preview-scroll"></div>
            <pre id="code-viewer" class="code-viewer"><code></code></pre>
            <figure id="image-viewer" class="image-viewer" aria-label="Image preview">
              <img id="image-viewer-img" alt="" loading="lazy" />
              <figcaption id="image-viewer-caption"></figcaption>
              <div id="image-viewer-error" class="image-viewer__fallback" hidden>
                Unable to load this image.
              </div>
            </figure>
            <figure id="video-viewer" class="video-viewer" aria-label="Video preview">
              <video id="video-viewer-video" controls preload="metadata"></video>
              <figcaption id="video-viewer-caption"></figcaption>
              <div id="video-viewer-error" class="video-viewer__fallback" hidden>
                Unable to load this video.
              </div>
            </figure>
            <div id="html-viewer" class="html-viewer" aria-label="HTML preview">
              <!-- HTML viewer iframe with sandbox allowing scripts and same-origin for proper functionality. -->
              <iframe id="html-viewer-frame" title="HTML Viewer" sandbox="allow-scripts allow-forms allow-popups allow-same-origin"></iframe>
              <div id="html-viewer-error" class="html-viewer__fallback" hidden>
                Unable to load this HTML file.
              </div>
            </div>
            <iframe id="pdf-viewer" class="pdf-viewer" title="PDF Viewer" role="document" tabindex="-1" aria-hidden="true"></iframe>
          </section>

          <!-- Math WYSIWYG Panel -->
          <aside id="math-wysiwyg-panel" class="math-wysiwyg-panel" hidden aria-label="Math WYSIWYG" style="display:none;">
            <div class="math-wysiwyg__header">
              <h3>Math Blocks</h3>
              <button id="math-wysiwyg-close" class="icon-button small" aria-label="Close" onclick="(function(){const p=document.getElementById('math-wysiwyg-panel'); if(p){p.hidden=true; p.style.display='none';}})()">‚úï</button>
            </div>
            <div id="math-wysiwyg-list" class="math-wysiwyg__list">
              <!-- dynamically populated -->
            </div>
          </aside>

          <!-- Math Edit Modal -->
          <div id="math-edit-modal" class="modal" hidden aria-hidden="true" style="display:none;">
            <div class="modal__content">
              <div class="modal__header">
                <h4>Edit Math Block</h4>
                <button id="math-edit-close" class="icon-button small" aria-label="Close" onclick="(function(){const m=document.getElementById('math-edit-modal'); if(m){m.hidden=true; m.style.display='none'; m.setAttribute('aria-hidden','true');}})()">‚úï</button>
              </div>
              <div class="modal__body">
                <textarea id="math-edit-textarea" rows="6"></textarea>
                <div id="math-edit-preview" class="math-edit__preview"></div>
              </div>
              <div class="modal__footer">
                <button id="math-edit-cancel" class="ghost small" onclick="(function(){const m=document.getElementById('math-edit-modal'); if(m){m.hidden=true; m.style.display='none'; m.setAttribute('aria-hidden','true');}})()">Cancel</button>
                <button id="math-edit-save" class="primary small">Save</button>
              </div>
            </div>
          </div>

          <!-- Table of Contents Modal -->
          <div id="toc-modal" class="modal" hidden aria-hidden="true" style="display:none;">
            <div class="modal__content">
              <div class="modal__header">
                <h4>Table of Contents</h4>
                <button id="toc-close" class="icon-button small" aria-label="Close" onclick="(function(){const m=document.getElementById('toc-modal'); if(m){m.hidden=true; m.style.display='none'; m.setAttribute('aria-hidden','true');}})()">‚úï</button>
              </div>
              <div class="modal__body">
                <div id="toc-content" class="toc-content">
                  <!-- Table of contents will be generated here -->
                </div>
              </div>
              <div class="modal__footer">
                <button id="toc-insert" class="primary small">Insert at Cursor</button>
                <button id="toc-copy" class="ghost small">Copy to Clipboard</button>
              </div>
            </div>
          </div>

          <!-- Statistics Modal -->
          <div id="stats-modal" class="modal" hidden aria-hidden="true" style="display:none;">
            <div class="modal__content">
              <div class="modal__header">
                <h4>Note Statistics</h4>
                <button id="stats-close" class="icon-button small" aria-label="Close" onclick="(function(){const m=document.getElementById('stats-modal'); if(m){m.hidden=true; m.style.display='none'; m.setAttribute('aria-hidden','true');}})()">‚úï</button>
              </div>
              <div class="modal__body">
                <div id="stats-content" class="stats-content">
                  <div class="stats-grid">
                    <div class="stat-item">
                      <div class="stat-label">Words</div>
                      <div class="stat-value" id="stat-words">0</div>
                    </div>
                    <div class="stat-item">
                      <div class="stat-label">Characters</div>
                      <div class="stat-value" id="stat-chars">0</div>
                    </div>
                    <div class="stat-item">
                      <div class="stat-label">Characters (no spaces)</div>
                      <div class="stat-value" id="stat-chars-no-spaces">0</div>
                    </div>
                    <div class="stat-item">
                      <div class="stat-label">Lines</div>
                      <div class="stat-value" id="stat-lines">0</div>
                    </div>
                    <div class="stat-item">
                      <div class="stat-label">Paragraphs</div>
                      <div class="stat-value" id="stat-paragraphs">0</div>
                    </div>
                    <div class="stat-item">
                      <div class="stat-label">Headings</div>
                      <div class="stat-value" id="stat-headings">0</div>
                    </div>
                    <div class="stat-item">
                      <div class="stat-label">Links</div>
                      <div class="stat-value" id="stat-links">0</div>
                    </div>
                    <div class="stat-item">
                      <div class="stat-label">Images</div>
                      <div class="stat-value" id="stat-images">0</div>
                    </div>
                    <div class="stat-item">
                      <div class="stat-label">Code Blocks</div>
                      <div class="stat-value" id="stat-code-blocks">0</div>
                    </div>
                    <div class="stat-item">
                      <div class="stat-label">Math Expressions</div>
                      <div class="stat-value" id="stat-math">0</div>
                    </div>
                    <div class="stat-item">
                      <div class="stat-label">Reading Time</div>
                      <div class="stat-value" id="stat-reading-time">0 min</div>
                    </div>
                    <div class="stat-item">
                      <div class="stat-label">Hashtags</div>
                      <div class="stat-value" id="stat-hashtags">0</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Templates Modal -->
          <div id="templates-modal" class="modal" hidden aria-hidden="true" style="display:none;">
            <div class="modal__content">
              <div class="modal__header">
                <h4>Note Templates</h4>
                <button id="templates-close" class="icon-button small" aria-label="Close" onclick="(function(){const m=document.getElementById('templates-modal'); if(m){m.hidden=true; m.style.display='none'; m.setAttribute('aria-hidden','true');}})()">‚úï</button>
              </div>
              <div class="modal__body">
                <div id="templates-content" class="templates-content">
                  <div class="templates-grid">
                    <div class="template-item" data-template="meeting">
                      <div class="template-icon">üë•</div>
                      <div class="template-name">Meeting Notes</div>
                      <div class="template-description">Structured notes for meetings</div>
                    </div>
                    <div class="template-item" data-template="project">
                      <div class="template-icon">üìã</div>
                      <div class="template-name">Project Plan</div>
                      <div class="template-description">Project planning and tracking</div>
                    </div>
                    <div class="template-item" data-template="research">
                      <div class="template-icon">üî¨</div>
                      <div class="template-name">Research Notes</div>
                      <div class="template-description">Research planning and tracking</div>
                    </div>
                    <div class="template-item" data-template="journal">
                      <div class="template-icon">üìì</div>
                      <div class="template-name">Daily Journal</div>
                      <div class="template-description">Daily reflection template</div>
                    </div>
                    <div class="template-item" data-template="todo">
                      <div class="template-icon">‚úÖ</div>
                      <div class="template-name">Task List</div>
                      <div class="template-description">Organized todo list</div>
                    </div>
                    <div class="template-item" data-template="matrix3x3">
                      <div class="template-icon">üî¢</div>
                      <div class="template-name">3√ó3 Matrix</div>
                      <div class="template-description">Mathematical matrix template</div>
                    </div>
                    <div class="template-item" data-template="identity3x3">
                      <div class="template-icon">üÜî</div>
                      <div class="template-name">Identity Matrix</div>
                      <div class="template-description">3√ó3 identity matrix</div>
                    </div>
                    <div class="template-item" data-template="table3x2">
                      <div class="template-icon">üìä</div>
                      <div class="template-name">3√ó2 Table</div>
                      <div class="template-description">Markdown table template</div>
                    </div>
                    <div class="template-item" data-template="journal">
                      <div class="template-icon">üìî</div>
                      <div class="template-name">Daily Journal</div>
                      <div class="template-description">Personal daily reflections</div>
                    </div>
                    <div class="template-item" data-template="todo">
                      <div class="template-icon">‚úÖ</div>
                      <div class="template-name">Task List</div>
                      <div class="template-description">Organized todo list</div>
                    </div>
                    <div class="template-item" data-template="blank">
                      <div class="template-icon">üìÑ</div>
                      <div class="template-name">Blank Note</div>
                      <div class="template-description">Start with a clean slate</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <footer class="status-bar">
          <span id="status-text" aria-live="polite">Ready.</span>
          <div class="status-bar__autosave" aria-live="polite">
            <div class="autosave-dot" id="autosave-dot" title="Autosave status"></div>
            <div id="autosave-text">Autosave off</div>
            <button class="save-now" id="save-now-button" title="Save Now">Save now</button>
          </div>
          <button id="settings-button" class="status-bar__settings" title="Settings">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
          </button>
        </footer>
      </main>
    </div>

    <!-- Terminal Container -->
    <div id="nta-terminal-container" class="nta-terminal-container" style="display: none;">
      <div id="nta-terminal" class="nta-terminal"></div>
    </div>

    <script src="../../node_modules/marked/marked.min.js"></script>
    <script src="../../node_modules/dompurify/dist/purify.min.js"></script>
    <script src="../../node_modules/katex/dist/katex.min.js"></script>
    <script src="../../node_modules/katex/dist/contrib/auto-render.min.js"></script>
    <link rel="stylesheet" href="../../node_modules/xterm/css/xterm.css">
    <script src="../../node_modules/xterm/lib/xterm.js"></script>
    <script type="module">
      import { createTreeModule } from './tree.js';
      window.createTreeModule = createTreeModule;
    </script>
    <script type="module" src="./app.js"></script>

    <div id="workspace-context-menu" class="context-menu" role="menu" hidden>
      <button type="button" data-action="cut" role="menuitem">Cut</button>
      <button type="button" data-action="copy" role="menuitem">Copy</button>
      <button type="button" data-action="paste" role="menuitem">Paste</button>
      <div class="context-menu__separator"></div>
      <button type="button" data-action="rename" role="menuitem">Rename</button>
      <button type="button" data-action="reveal" role="menuitem">Show in Finder</button>
      <button type="button" data-action="delete" role="menuitem" class="danger">Delete</button>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="settings-modal">
      <div class="settings-modal__content">
        <div class="settings-modal__header">
          <h2 class="settings-modal__title">Settings</h2>
          <button id="settings-close" class="settings-modal__close" title="Close Settings">&times;</button>
        </div>
        
        <!-- Settings Navigation -->
        <div class="settings-nav">
          <button class="settings-nav__item active" data-tab="appearance">Appearance</button>
          <button class="settings-nav__item" data-tab="accessibility">Accessibility</button>
          <button class="settings-nav__item" data-tab="layout">Layout</button>
          <button class="settings-nav__item" data-tab="export">Export</button>
          <button class="settings-nav__item" data-tab="application">Application</button>
          <button class="settings-nav__item" data-tab="advanced">Advanced</button>
        </div>
        
        <!-- Settings Content -->
        <div class="settings-modal__body">
          <div class="settings-tabs-container">
            
            <!-- Appearance Tab -->
            <div class="settings-tab active" id="appearance-tab">
              <div class="settings-section">
                <div class="settings-item">
                  <label class="settings-item__label">Theme</label>
                  <select id="theme-select" class="settings-select">
                    <option value="system">System</option>
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                  </select>
                </div>
                <div class="settings-item">
                  <label class="settings-item__label">Background Color</label>
                  <div class="color-picker-group">
                    <input type="color" id="bg-color-picker" class="color-picker" value="#f7f8fa">
                    <button id="reset-bg-color" class="settings-button--secondary">Reset</button>
                  </div>
                </div>

                <div class="settings-item">
                  <label class="settings-item__label">Font Family</label>
                  <div class="font-family-group">
                    <select id="font-family-select" class="settings-select">
                      <option value="system">System Font (SF Pro)</option>
                      <option value="Inter">Inter</option>
                      <option value="Roboto">Roboto</option>
                      <option value="Open Sans">Open Sans</option>
                      <option value="Source Sans Pro">Source Sans Pro</option>
                      <option value="Lato">Lato</option>
                      <option value="Poppins">Poppins</option>
                      <option value="JetBrains Mono">JetBrains Mono (Monospace)</option>
                      <option value="Fira Code">Fira Code (Monospace)</option>
                      <option value="Monaco">Monaco (Monospace)</option>
                    </select>
                    <span id="font-preview-sample" class="font-preview-sample"></span>
                    <button id="reset-font-family" class="settings-button--secondary">Reset</button>
                  </div>
                </div>

                <div class="settings-item">
                  <label class="settings-item__label">Font Size</label>
                  <div class="slider-group">
                    <input type="range" id="font-size-slider" class="settings-slider" min="11" max="20" value="14" step="1">
                    <span id="font-size-value" class="slider-value">14px</span>
                    <button id="reset-font-size" class="settings-button--secondary">Reset</button>
                  </div>
                </div>
                <!-- Common extra settings -->
                <div class="settings-item">
                  <label class="settings-item__label">Autosave</label>
                  <div class="toggle-group">
                    <input type="checkbox" id="autosave-toggle" class="settings-toggle">
                    <label for="autosave-toggle" class="toggle-label">Enable autosave</label>
                  </div>
                </div>
                <div class="settings-item">
                  <label class="settings-item__label">Autosave Interval</label>
                  <div class="slider-group">
                    <input type="range" id="autosave-interval" class="settings-slider" min="5" max="300" value="30" step="5">
                    <span id="autosave-interval-value" class="slider-value">30s</span>
                  </div>
                </div>
                <div class="settings-item">
                  <label class="settings-item__label">Editor Spellcheck</label>
                  <div class="toggle-group">
                    <input type="checkbox" id="spellcheck-toggle" class="settings-toggle" checked>
                    <label for="spellcheck-toggle" class="toggle-label">Enable spellcheck in editor</label>
                  </div>
                </div>
                <div class="settings-item">
                  <label class="settings-item__label">Soft Wrap</label>
                  <div class="toggle-group">
                    <input type="checkbox" id="softwrap-toggle" class="settings-toggle" checked>
                    <label for="softwrap-toggle" class="toggle-label">Wrap long lines in editor</label>
                  </div>
                </div>
                
              </div>
            </div>
            
            <!-- Accessibility Tab -->
            <div class="settings-tab" id="accessibility-tab">
              <div class="settings-section">
                <div class="settings-item">
                  <label class="settings-item__label">High Contrast Mode</label>
                  <div class="toggle-group">
                    <input type="checkbox" id="high-contrast-toggle" class="settings-toggle">
                    <label for="high-contrast-toggle" class="toggle-label">Enable high contrast mode for better accessibility</label>
                  </div>
                </div>
                
                <div class="settings-section">
                  <h4 class="settings-section__title">Keyboard Shortcuts</h4>
                  <div class="settings-item">
                    <label class="settings-item__label">Add Custom Keybinding</label>
                    <div class="keybinding-controls">
                      <div class="keybinding-input-group">
                        <select id="keybinding-action-select" class="keybinding-select">
                          <option value="">Select Action</option>
                          <option value="export-pdf">Export PDF</option>
                          <option value="export-html">Export HTML</option>
                          <option value="settings">Open Settings</option>
                          <option value="bold">Bold Text</option>
                          <option value="italic">Italic Text</option>
                          <option value="code">Code Block</option>
                          <option value="link">Insert Link</option>
                          <option value="insert-latex">Insert LaTeX Block</option>
                          <option value="open-citation">Open Citation Picker</option>
                        </select>
                        <input type="text" id="keybinding-keys-input" class="keybinding-input" placeholder="Press keys (e.g., Ctrl+S)" readonly>
                        <button id="add-keybinding-btn" class="settings-button--primary">Add</button>
                      </div>
                      <div id="keybindings-list" class="keybindings-list">
                        <!-- Keybindings will be populated dynamically -->
                      </div>
                      <button id="reset-keybindings-btn" class="settings-button--secondary">Reset to Defaults</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Layout Tab -->
            <div class="settings-tab" id="layout-tab">
              <div class="settings-section">
                <div class="settings-item">
                  <label class="settings-item__label">Border Color</label>
                  <div class="color-picker-group">
                    <input type="color" id="border-color-picker" class="color-picker" value="#e2e8f0">
                    <button id="reset-border-color" class="settings-button--secondary">Reset</button>
                  </div>
                </div>
                <div class="settings-item">
                  <label class="settings-item__label">Border Thickness</label>
                  <div class="slider-group">
                    <input type="range" id="border-thickness-slider" class="settings-slider" min="1" max="4" value="1" step="1">
                    <span id="border-thickness-value" class="slider-value">1px</span>
                    <button id="reset-border-thickness" class="settings-button--secondary">Reset</button>
                  </div>
                </div>
                <div class="settings-item">
                  <label class="settings-item__label">Show Line Numbers</label>
                  <div class="toggle-group">
                    <input type="checkbox" id="show-line-numbers" class="settings-toggle">
                    <label for="show-line-numbers" class="toggle-label">Show line numbers in editor</label>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Export Tab -->
            <div class="settings-tab" id="export-tab">
              <div class="settings-section">
                <div class="settings-item">
                  <label class="settings-item__label">Default Export Format</label>
                  <select id="default-export-format-select" class="settings-select">
                    <option value="pdf">PDF</option>
                    <option value="html">HTML</option>
                    <option value="docx">DOCX</option>
                    <option value="epub">EPUB</option>
                  </select>
                </div>
                <div class="settings-item">
                  <label class="settings-item__label">Direct Export with Cmd+E</label>
                  <div class="toggle-group">
                    <input type="checkbox" id="cmd-e-direct-export-toggle" class="settings-toggle">
                    <label for="cmd-e-direct-export-toggle" class="toggle-label">When enabled, Cmd+E exports using the default format. When disabled, opens the export menu.</label>
                  </div>
                </div>
                <div class="settings-item">
                  <label class="settings-item__label">Export Settings</label>
                  <div class="export-controls">
                    <button id="export-settings-btn" class="settings-button">Export Settings</button>
                    <select id="export-format-select" class="settings-select">
                      <option value="json">JSON Format</option>
                      <option value="yaml">YAML Format</option>
                      <option value="txt">Text Format</option>
                    </select>
                  </div>
                </div>
                <div class="settings-item">
                  <label class="settings-item__label">Import Settings</label>
                  <div class="import-controls">
                    <input type="file" id="import-settings-input" accept=".json,.yaml,.yml,.txt" style="display: none;">
                    <button id="import-settings-btn" class="settings-button--secondary">Import Settings</button>
                    <span id="import-status" class="import-status"></span>
                  </div>
                </div>
                <div class="settings-item">
                  <label class="settings-item__label">Export Preview</label>
                  <div class="export-preview">
                    <textarea id="export-preview-text" class="export-preview__text" readonly placeholder="Settings will appear here when you click Export..."></textarea>
                    <div class="export-preview__actions">
                      <button id="copy-settings-btn" class="settings-button--secondary" disabled>Copy to Clipboard</button>
                      <button id="download-settings-btn" class="settings-button--secondary" disabled>Download File</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Advanced Tab -->
            <div class="settings-tab" id="advanced-tab">
              <div class="settings-section">
                <!-- Component-specific Settings -->
                <div class="settings-divider">
                  <h3 class="settings-divider__title">Component Settings</h3>
                </div>
                
                <!-- Component Selector -->
                <div class="settings-item">
                  <label class="settings-item__label">Select Component</label>
                  <select id="component-selector" class="settings-select">
                    <option value="workspace">Workspace</option>
                    <option value="editor">Editor</option>
                    <option value="preview">Preview</option>
                    <option value="statusbar">Status Bar</option>
                    <option value="titlebar">Title Bar</option>
                  </select>
                </div>
                
                <!-- Unified Component Settings -->
                <div id="component-settings" class="component-settings-container">
                  <!-- Background Color Setting -->
                  <div class="settings-item">
                    <label class="settings-item__label">
                      <input type="checkbox" id="component-use-global-bg" class="settings-checkbox" checked>
                      Use Global Background Color
                    </label>
                    <div class="color-picker-group" id="component-bg-controls">
                      <input type="color" id="component-bg-color-picker" class="color-picker" value="#f1f3f4" disabled>
                      <button id="reset-component-bg-color" class="settings-button--secondary" disabled>Reset</button>
                    </div>
                  </div>
                  
                  <!-- Font Family Setting -->
                  <div class="settings-item">
                    <label class="settings-item__label">
                      <input type="checkbox" id="component-use-global-font" class="settings-checkbox" checked>
                      Use Global Font Family
                    </label>
                    <div class="font-family-group" id="component-font-controls">
                      <select id="component-font-family-select" class="settings-select" disabled>
                        <option value="system">System Font (SF Pro)</option>
                        <option value="Inter">Inter</option>
                        <option value="Roboto">Roboto</option>
                        <option value="Open Sans">Open Sans</option>
                        <option value="Source Sans Pro">Source Sans Pro</option>
                        <option value="Lato">Lato</option>
                        <option value="Poppins">Poppins</option>
                        <option value="JetBrains Mono">JetBrains Mono (Monospace)</option>
                        <option value="Fira Code">Fira Code (Monospace)</option>
                        <option value="Monaco">Monaco (Monospace)</option>
                      </select>
                      <button id="reset-component-font-family" class="settings-button--secondary" disabled>Reset</button>
                    </div>
                  </div>
                  
                  <!-- Font Size Setting -->
                  <div class="settings-item">
                    <label class="settings-item__label">
                      <input type="checkbox" id="component-use-global-size" class="settings-checkbox" checked>
                      Use Global Font Size
                    </label>
                    <div class="slider-group" id="component-size-controls">
                      <input type="range" id="component-font-size-slider" class="settings-slider" min="10" max="20" value="13" step="1" disabled>
                      <span id="component-font-size-value" class="slider-value">13px</span>
                      <button id="reset-component-font-size" class="settings-button--secondary" disabled>Reset</button>
                    </div>
                  </div>
                  
                  <!-- Text Color Setting -->
                  <div class="settings-item">
                    <label class="settings-item__label">
                      <input type="checkbox" id="component-use-global-color" class="settings-checkbox" checked>
                      Use Global Text Color
                    </label>
                    <div class="color-picker-group" id="component-color-controls">
                      <input type="color" id="component-text-color-picker" class="color-picker" value="#374151" disabled>
                      <button id="reset-component-text-color" class="settings-button--secondary" disabled>Reset</button>
                    </div>
                  </div>
                  
                  <!-- Font Style Setting -->
                  <div class="settings-item">
                    <label class="settings-item__label">
                      <input type="checkbox" id="component-use-global-style" class="settings-checkbox" checked>
                      Use Global Font Style
                    </label>
                    <select id="component-font-style-select" class="settings-select" disabled>
                      <option value="normal">Normal</option>
                      <option value="italic">Italic</option>
                      <option value="oblique">Oblique</option>
                    </select>
                  </div>
                  
                  <!-- Title bar-specific setting removed (macOS titlebar is handled by OS) -->
                </div>
                
                <!-- Status Bar Position Setting -->
                <div class="settings-item">
                  <label class="settings-item__label">Status Bar Position</label>
                  <select id="status-bar-position-select" class="settings-select">
                    <option value="bottom">Bottom</option>
                    <option value="top">Top</option>
                    <option value="hidden">Hidden</option>
                    <option value="right">Right</option>
                    <option value="left">Left</option>
                  </select>
                </div>
                
                <!-- New Settings -->
                <div class="settings-item">
                  <label class="settings-item__label">Auto-save Interval</label>
                  <div class="slider-group">
                    <input type="range" id="autosave-interval-slider" class="settings-slider" min="5" max="300" value="30" step="5">
                    <span id="autosave-interval-value" class="slider-value">30s</span>
                    <button id="reset-autosave-interval" class="settings-button--secondary">Reset</button>
                  </div>
                </div>
                
                <div class="settings-item">
                  <label class="settings-item__label">Word Wrap</label>
                  <div class="toggle-group">
                    <input type="checkbox" id="word-wrap-toggle" class="settings-toggle">
                    <label for="word-wrap-toggle" class="toggle-label">Enable word wrapping in editor</label>
                  </div>
                </div>
                
                <div class="settings-item">
                  <label class="settings-item__label">Default File Extension</label>
                  <select id="default-file-extension-select" class="settings-select">
                    <option value=".md">.md (Markdown)</option>
                    <option value=".txt">.txt (Plain Text)</option>
                    <option value=".markdown">.markdown</option>
                  </select>
                </div>
                
                <div class="settings-item">
                  <label class="settings-item__label">Show Hidden Files</label>
                  <div class="toggle-group">
                    <input type="checkbox" id="show-hidden-files-toggle" class="settings-toggle">
                    <label for="show-hidden-files-toggle" class="toggle-label">Show hidden files in workspace tree</label>
                  </div>
                </div>
                
                <div class="settings-item">
                  <label class="settings-item__label">Maximum Recent Files</label>
                  <div class="slider-group">
                    <input type="range" id="max-recent-files-slider" class="settings-slider" min="5" max="50" value="20" step="5">
                    <span id="max-recent-files-value" class="slider-value">20</span>
                    <button id="reset-max-recent-files" class="settings-button--secondary">Reset</button>
                  </div>
                </div>
                
                <div class="settings-item">
                  <label class="settings-item__label">Maximum Image File Size</label>
                  <div class="slider-group">
                    <input type="range" id="max-image-size-slider" class="settings-slider" min="1" max="50" value="10" step="1">
                    <span id="max-image-size-value" class="slider-value">10MB</span>
                    <button id="reset-max-image-size" class="settings-button--secondary">Reset</button>
                  </div>
                </div>
                
                <div class="settings-item">
                  <label class="settings-item__label">Maximum Video File Size</label>
                  <div class="slider-group">
                    <input type="range" id="max-video-size-slider" class="settings-slider" min="10" max="500" value="100" step="10">
                    <span id="max-video-size-value" class="slider-value">100MB</span>
                    <button id="reset-max-video-size" class="settings-button--secondary">Reset</button>
                  </div>
                </div>
                
                <div class="settings-item">
                  <label class="settings-item__label">Maximum Script File Size</label>
                  <div class="slider-group">
                    <input type="range" id="max-script-size-slider" class="settings-slider" min="1" max="20" value="5" step="1">
                    <span id="max-script-size-value" class="slider-value">5MB</span>
                    <button id="reset-max-script-size" class="settings-button--secondary">Reset</button>
                  </div>
                </div>
                
                <!-- Super Advanced Toggle -->
                <div class="settings-item">
                  <label class="settings-item__label">Super Advanced Settings</label>
                  <button id="super-advanced-toggle" class="settings-arrow-toggle" data-target="super-advanced">
                    <span class="toggle-icon">‚ñ∂</span>
                  </button>
                </div>
                
                <!-- Super Advanced Settings (Hidden by default) -->
                <div id="super-advanced" class="settings-advanced" hidden>
                  <!-- Title bar / traffic-light controls removed -->
                  <div class="settings-item">
                    <label class="settings-item__label">Status Bar Size</label>
                    <div class="slider-group">
                      <input type="range" id="status-bar-size-slider" class="settings-slider" min="20" max="40" value="28" step="2">
                      <span id="status-bar-size-value" class="slider-value">28px</span>
                      <button id="reset-status-bar-size" class="settings-button--secondary">Reset</button>
                    </div>
                  </div>
                  <div class="settings-item">
                    <label class="settings-item__label">Editor Tab Size</label>
                    <div class="slider-group">
                      <input type="range" id="editor-tab-size-slider" class="settings-slider" min="2" max="8" value="4" step="1">
                      <span id="editor-tab-size-value" class="slider-value">4</span>
                      <button id="reset-editor-tab-size" class="settings-button--secondary">Reset</button>
                    </div>
                  </div>
                  <div class="settings-item">
                    <label class="settings-item__label">Import Font</label>
                    <input type="file" id="font-import" class="settings-file-input" accept=".ttf,.otf,.woff,.woff2">
                    <button id="font-import-btn" class="settings-button--secondary">Choose Font File</button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Application Tab -->
            <div class="settings-tab" id="application-tab">
              <div class="settings-section">
                <div class="settings-item">
                      <label class="settings-item__label">Check for Updates</label>
                        <div class="update-check-row">
                          <div class="check-button-column">
                            <button id="check-updates-btn" class="settings-button">Check Now</button>
                            <div id="check-updates-submessage" class="settings-submessage" aria-live="polite"></div>
                          </div>
                          <div>
                            <button id="update-download-button" class="settings-button">Open Release Page</button>
                          </div>
                        </div>
                    </div>
                <div class="settings-item">
                  <label class="settings-item__label">App Version</label>
                  <div id="app-version">Loading...</div>
                </div>
              </div>
            </div>
            
          </div>
        </div>
      </div>
    </div>
  </body>
</html>